<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Student Programme Audit</title>

    <!-- Bootstrap CSS (Important for the modal) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <!-- Your custom stylesheet -->
    <link rel="stylesheet" th:href="@{/scripts/css/audit.css}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
<!-- Include the navigation bar fragment -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<h2 id="studentHeader">Programme Audit</h2>
<div id="studentInfo" class="student-info"></div>

<!-- Filter Buttons -->
<div style="margin-top: 20px;">
    <strong>Filter:</strong>
    <button onclick="setFilter('all')">All</button>
    <button onclick="setFilter('enrolled')">Enrolled</button>
    <button onclick="setFilter('completed')">Completed</button>
    <button onclick="setFilter('notTaken')">Not Taken</button>
</div>

<!-- Table -->
<table id="auditTable" style="display:none;">
    <thead><tr></tr></thead>
    <tbody id="courseTableBody"></tbody>
</table>

<!-- Pie Chart -->
<div style="width: 100%; max-width: 250px; margin: 30px auto;">
    <canvas id="auditChart"></canvas>
</div>

<!-- Legend -->
<div id="legend" style="margin-top: 15px;">
    <p>
        <span style="margin-right: 20px;">Ⓡ = Currently Enrolled</span>
        <span style="margin-right: 20px;">&#x2713; = Completed</span>
    </p>
    <p>
        <strong>Completed:</strong> <span id="completedCount">0</span> |
        <strong>Remaining:</strong> <span id="remainingCount">0</span> |
        <strong>Total:</strong> <span id="totalCount">0</span>
    </p>
</div>

<!-- Mermaid Modal -->
<div class="modal fade" id="mermaidModal" tabindex="-1" aria-labelledby="mermaidModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mermaidModalLabel">Prerequisite Diagram</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="mermaidRenderContainer" style="overflow-x: auto; padding: 10px;"></div>
                <div id="noPrereqsMessage" style="display: none; font-style: italic; padding: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Thymeleaf JS Var -->
<script th:inline="javascript">
    let studentId = /*[[${studentId}]]*/ "fallbackId";
</script>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let rawData = null;
    let currentFilter = 'all';
    let chartInstance = null;

    function setFilter(filter) {
        currentFilter = filter;
        if (rawData) renderAuditTable(rawData);
    }

    fetch(`/api/studentAudit/${studentId}`)
        .then(res => res.json())
        .then(data => {
            rawData = data;
            renderAuditTable(data);
            const total = data.programmeCourses.length;
            const completed = data.programmeCourses.filter(c => c.completed).length;
            renderChart(completed, total - completed);
        })
        .catch(err => {
            console.error(err);
            document.getElementById("studentInfo").innerText = "❌ Failed to load audit.";
        });

    function renderAuditTable(data) {
        document.getElementById("studentHeader").innerText = `Programme Audit for ${data.studentName}`;
        document.getElementById("studentInfo").innerHTML = `
            <p><strong>Student ID:</strong> ${data.studentId}</p>
            <p><strong>Programme:</strong> ${data.programmeName || "N/A"}</p>
            <p><strong>Status:</strong> ${data.status}</p>
        `;

        const levels = [100, 200, 300, 400];
        const grouped = {};
        const levelStats = {};
        let totalCourses = 0;
        let totalCompleted = 0;

        levels.forEach(level => {
            grouped[level] = [];
            levelStats[level] = { total: 0, completed: 0 };
        });

        data.programmeCourses.forEach(course => {
            const level = course.level || 100;
            const isEnrolled = course.enrolled;
            const isCompleted = course.completed;

            // Apply filter
            if (currentFilter === 'enrolled' && !isEnrolled) return;
            if (currentFilter === 'completed' && !isCompleted) return;
            if (currentFilter === 'notTaken' && (isEnrolled || isCompleted)) return;

            let status = '';
            if (isEnrolled) status += '<span class="enrolled">Ⓡ</span>';
            if (isCompleted) status += '<span class="completed">&#x2713;</span>';

            grouped[level].push(`
                <div>
                    <div>${course.courseCode} ${status}</div>
                    <button class="btn btn-sm btn-outline-primary mt-1"
                            onclick="viewPrereqDiagram(${course.id}, '${course.courseCode}')">
                        View Prerequisite Diagram
                    </button>
                </div>
            `);

            levelStats[level].total += 1;
            if (isCompleted) levelStats[level].completed += 1;

            totalCourses += 1;
            if (isCompleted) totalCompleted += 1;
        });

        const thead = document.querySelector("#auditTable thead tr");
        thead.innerHTML = levels.map(level => {
            const stat = levelStats[level];
            return `<th>Level ${level}<br><span style="font-size: 12px;">${stat.completed}/${stat.total}</span></th>`;
        }).join('');

        const tbody = document.getElementById("courseTableBody");
        tbody.innerHTML = '';
        const maxRows = Math.max(...Object.values(grouped).map(list => list.length));
        for (let i = 0; i < maxRows; i++) {
            let row = '<tr>';
            levels.forEach(level => {
                const course = grouped[level][i] || '';
                row += `<td>${course}</td>`;
            });
            row += '</tr>';
            tbody.innerHTML += row;
        }

        document.getElementById("auditTable").style.display = "table";
        document.getElementById("completedCount").innerText = totalCompleted;
        document.getElementById("remainingCount").innerText = totalCourses - totalCompleted;
        document.getElementById("totalCount").innerText = totalCourses;
    }

    function renderChart(completed, remaining) {
        const ctx = document.getElementById("auditChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Completed', 'Remaining'],
                datasets: [{
                    data: [completed, remaining],
                    backgroundColor: ['#4caf50', '#cccccc'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'bottom' }
                },
                responsive: true
            }
        });
    }

    function viewPrereqDiagram(courseId, courseCode) {
        document.getElementById("mermaidModalLabel").innerText = `Prerequisite Diagram for ${courseCode}`;
        document.getElementById("mermaidRenderContainer").innerHTML = 'Loading...';
        document.getElementById("noPrereqsMessage").style.display = "none";

        fetch("/api/student/getMermaidCode", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ courseId: courseId })
        })
            .then(res => res.text())
            .then(code => {
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('mermaidModal'));
                modal.show();

                if (code.trim().startsWith("%% No prerequisites")) {
                    document.getElementById("mermaidRenderContainer").innerHTML = '';
                    document.getElementById("noPrereqsMessage").innerText = code;
                    document.getElementById("noPrereqsMessage").style.display = "block";
                } else {
                    mermaid.render("generatedDiagram", code).then(({ svg }) => {
                        document.getElementById("mermaidRenderContainer").innerHTML =
                            `<div style="min-width: 100%; padding: 10px;">${svg}</div>`;
                    }).catch(err => {
                        document.getElementById("mermaidRenderContainer").innerHTML = '';
                        document.getElementById("noPrereqsMessage").innerText = "❌ Failed to render diagram.";
                        document.getElementById("noPrereqsMessage").style.display = "block";
                    });
                }
            })
            .catch(err => {
                document.getElementById("mermaidRenderContainer").innerHTML = '';
                document.getElementById("noPrereqsMessage").innerText = "❌ Failed to load diagram.";
                document.getElementById("noPrereqsMessage").style.display = "block";
            });
    }
</script>

</body>
</html>
