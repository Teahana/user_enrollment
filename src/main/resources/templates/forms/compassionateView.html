<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>View Compassionate Application</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/styles/navbar.css}">
  <style>
    .label { font-weight: bold; }
    .section { margin-top: 2rem; }
  </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container mt-4">
  <h2>Compassionate Application Review</h2>

  <div class="section">
    <div><span class="label">Application Type:</span> <span th:text="${app.applicationType}"></span></div>
    <div><span class="label">Reason:</span> <pre th:text="${app.reason}"></pre></div>
    <div><span class="label">Status:</span> <span th:text="${app.status}"></span></div>
    <div><span class="label">Submission Date:</span> <span th:text="${app.submissionDate}"></span></div>
  </div>

  <div class="section">
    <h5>Missed Exams</h5>
    <table class="table table-bordered">
      <thead>
      <tr>
        <th>Course Code</th>
        <th>Exam Date</th>
        <th>Exam Time</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="entry : ${app.examEntries}">
        <td th:text="${entry.courseCode}"></td>
        <td th:text="${entry.examDate}"></td>
        <td th:text="${entry.examTime}"></td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <h5>Student Info</h5>
    <p><strong>Name:</strong> <span th:text="${student.firstName + ' ' + student.lastName}"></span></p>
    <p><strong>Student ID:</strong> <span th:text="${student.studentId}"></span></p>
    <p><strong>Email:</strong> <span th:text="${student.email}"></span></p>
    <p><strong>Phone:</strong> <span th:text="${student.phoneNumber}"></span></p>
    <p><strong>Address:</strong> <span th:text="${student.address}"></span></p>
    <p><strong>Campus:</strong> <span th:text="${app.campus}"></span></p>
    <p><strong>Semester/Year:</strong> <span th:text="${app.semesterYear}"></span></p>
  </div>

  <script th:inline="javascript">
    const filePaths = /*[[${app.documentPaths}]]*/ [];

    document.addEventListener("DOMContentLoaded", () => {
      const list = document.getElementById("documentList");

      // 🔍 Fetch and render file metadata via POST
      fetch("/api/admin/fileMeta", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(filePaths)
      })
              .then(response => response.json())
              .then(files => {
                files.forEach(file => {
                  const li = document.createElement("li");
                  li.innerHTML = `
          <strong>${file.name}</strong> (${file.mimeType})
          <a href="/api/admin/getFile/${encodeURIComponent(file.name)}"
        `;
                  list.appendChild(li);
                });
              })
              .catch(err => {
                console.error("Failed to fetch file metadata", err);
              });

      // 📥 Download All button (unchanged)
      document.getElementById("downloadAllBtn").addEventListener("click", () => {
        fetch("/api/admin/getFiles", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ filePaths: filePaths })  // send as JSON map
        })
                .then(res => res.blob())
                .then(blob => {
                  const zipUrl = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = zipUrl;
                  a.download = "supporting_documents.zip";
                  document.body.appendChild(a);
                  a.click();
                  document.body.removeChild(a);
                  URL.revokeObjectURL(zipUrl);
                })
                .catch(err => {
                  console.error("Download failed", err);
                });
      });
    });
    // Signature Rendering
    const signaturePath = /*[[${app.studentSignatureFilePath}]]*/ "";

    fetch("/api/admin/getFile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ fileName: signaturePath })
    })
            .then(res => res.blob())
            .then(blob => {
              const img = new Image();
              img.onload = function () {
                const canvas = document.getElementById("signatureCanvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
              };
              img.src = URL.createObjectURL(blob);
            })
            .catch(err => {
              console.error("Failed to load signature image", err);
            });

  </script>
  <div class="section">
    <h5>Attached Documents</h5>
    <ul id="documentList"></ul>
    <button id="downloadAllBtn" class="btn btn-primary mt-2">Download All</button>
  </div>


  <div class="section">
    <h5>Student Signature</h5>
    <canvas id="signatureCanvas" style="border:1px solid #ccc; max-width:400px;"></canvas>
  </div>
</div>
</body>
</html>
