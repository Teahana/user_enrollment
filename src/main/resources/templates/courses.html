<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses</title>
    <link rel="stylesheet" href="/styles/courses.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-3">Courses</h2>
    <div id="successDiv" class="alert" style="display: none;"></div>
    <div id="errorDiv" class="alert" style="display: none;"></div>
    <div id="feedbackDiv" class="alert" style="display: none;"></div>
    <!-- Search Input -->
    <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by Course Code">
    </div>

    <!-- Flash Messages -->
    <div th:if="${message}" class="alert alert-success" role="alert">
        <span th:text="${message}"></span>
    </div>
    <div th:if="${error}" class="alert alert-danger" role="alert">
        <span th:text="${error}"></span>
    </div>

    <!-- Add Course Button -->
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addCourseModal">
        Add Course
    </button>

    <!-- Course Table -->
    <table class="table table-bordered">
        <thead class="table-dark">
        <tr>
            <th>Course Code</th>
            <th>Title</th>
            <th>Description</th>
            <th>Credit Points</th>
            <th>Level</th>
            <th>Semester 1</th>
            <th>Semester 2</th>
            <th>Programmes</th>
            <th>Prerequisites</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="courseTableBody">
        <tr th:each="course : ${courses}">
            <td th:text="${course.courseCode}" class="courseCode"></td>
            <td th:text="${course.title}"></td>
            <td th:text="${course.description}"></td>
            <td th:text="${course.creditPoints}"></td>
            <td th:text="${course.level}"></td>
            <td>
                <span class="badge bg-success" th:if="${course.offeredSem1}">Yes</span>
                <span class="badge bg-danger" th:unless="${course.offeredSem1}">No</span>
            </td>
            <td>
                <span class="badge bg-success" th:if="${course.offeredSem2}">Yes</span>
                <span class="badge bg-danger" th:unless="${course.offeredSem2}">No</span>
            </td>
            <td>
                <span th:each="prog : ${course.programmes}" th:text="${prog} + ' '"></span>
            </td>
            <td th:text="${course.prerequisites}"></td>
            <td>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-primary"
                            type="button"
                            th:data-course-id="${course.id}"
                            th:data-course-code="${course.courseCode}"
                            th:data-title="${course.title}"
                            th:data-description="${course.description}"
                            th:data-creditpoints="${course.creditPoints}"
                            th:data-level="${course.level}"
                            th:data-offeredsem1="${course.offeredSem1}"
                            th:data-offeredsem2="${course.offeredSem2}"
                            th:data-prerequisites="${course.prerequisites}"
                            th:data-programmes="${#strings.listJoin(course.programmes, ' ')}"
                            onclick="openEditModal(this)">
                        Edit
                    </button>

                    <button class="btn btn-sm btn-secondary addPrereqBtn"
                            data-bs-toggle="modal"
                            data-bs-target="#addPrerequisiteModal"
                            th:data-course-id="${course.id}"
                            th:data-course-code="${course.courseCode}"
                            th:if="${not course.hasPreReqs}">
                        Add Prerequisites
                    </button>

                    <button class="btn btn-sm btn-warning editPrereqBtn"
                            th:data-course-id="${course.id}"
                            th:data-course-code="${course.courseCode}"
                            th:if="${course.hasPreReqs}">
                        Edit Prerequisites
                    </button>

                    <button class="btn btn-sm btn-danger removePrereqBtn"
                            th:data-course-id="${course.id}"
                            th:data-course-code="${course.courseCode}"
                            th:if="${course.hasPreReqs}">
                        Remove
                    </button>

                    <button class="btn btn-sm btn-info visualizeBtn"
                            th:data-course-code="${course.courseCode}"
                            th:data-expression="${course.prerequisites}"
                            th:if="${course.hasPreReqs}">
                        Visualize
                    </button>
                </div>
            </td>

        </tr>
        </tbody>
    </table>
</div>


<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1"
     aria-labelledby="addCourseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Course</h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form th:action="@{/admin/addCourse}" method="post">
                    <div class="mb-3">
                        <label class="form-label">Course Code</label>
                        <input type="text" class="form-control" name="courseCode" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credit Points</label>
                        <input type="number" class="form-control" name="creditPoints" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <input type="number" class="form-control" name="level" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Offered in Semester 1</label>
                        <input type="checkbox" class="form-check-input" name="offeredSem1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Offered in Semester 2</label>
                        <input type="checkbox" class="form-check-input" name="offeredSem2">
                    </div>
                    <button type="submit" class="btn btn-success">Add Course</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- ============================== -->
<!-- EDIT COURSE MODAL -->
<!-- ============================== -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form th:action="@{/admin/updateCourse}" method="post" id="editCourseForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Course</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <!-- Hidden field for the Course ID -->
                    <input type="hidden" name="id" id="editCourseId">

                    <!-- Course Code -->
                    <div class="mb-3">
                        <label class="form-label">Course Code</label>
                        <input type="text" class="form-control" name="courseCode" id="editCourseCode" required>
                    </div>

                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" name="title" id="editTitle" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editDescription" rows="3" required></textarea>
                    </div>

                    <!-- Credit Points -->
                    <div class="mb-3">
                        <label class="form-label">Credit Points</label>
                        <input type="text" class="form-control" name="creditPoints" id="editCreditPoints" pattern="\d+(\.\d{1,2})?" required>
                    </div>

                    <!-- Level -->
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <input type="number" class="form-control" name="level" id="editLevel" min="1" required>
                    </div>

                    <!-- Offered Semesters -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="offeredSem1" id="editOfferedSem1">
                        <label class="form-check-label" for="editOfferedSem1">Offered in Semester 1</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" name="offeredSem2" id="editOfferedSem2">
                        <label class="form-check-label" for="editOfferedSem2">Offered in Semester 2</label>
                    </div>

                    <!-- Programmes (multiple checkboxes) -->
                    <div class="mb-3">
                        <label class="form-label">Programmes</label>
                        <div id="editProgrammeList">
                            <!-- checkboxes inserted via JS -->
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        Update
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ===== Add Prerequisites Modal ===== -->
<div class="modal fade" id="addPrerequisiteModal" tabindex="-1"
     aria-labelledby="addPrerequisiteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Add Prerequisites for <span id="selectedCourseName"></span>
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPrerequisiteForm" action="/admin/confirmPreReqAdd" method="POST">
                    <input type="hidden" name="courseId" id="selectedCourseId">
                    <input type="hidden" name="successStatus" id="successStatus">
                    <input type="hidden" name="responseMessage" id="responseMessage">

                    <!-- Container where all top-level groups go -->
                    <div id="prerequisiteGroupsContainer" class="group-container">
                        <!-- Groups will be dynamically added here by JS -->
                    </div>

                    <!-- Button to add a new top-level prerequisite group -->
                    <button type="button"
                            class="btn btn-outline-primary mt-3"
                            onclick="addNewPrerequisiteGroup()">
                        + Add Prerequisite Group
                    </button>

                    <!-- Expression Preview -->
                    <div id="expressionPreview"
                         class="mt-3 p-2 border border-secondary rounded"
                         style="font-family:monospace; background:#fafafa;">
                        (Expression Preview will appear here)
                    </div>

                    <hr>
                    <!-- Submit Button -->
                    <button type="submit"
                            class="btn btn-success w-100 mt-2"
                            onclick="submitPrerequisiteForm(event)">
                        Save Prerequisites
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ===== Edit Prerequisites Modal ===== -->
<div class="modal fade" id="editPrerequisiteModal" tabindex="-1"
     aria-labelledby="editPrerequisiteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Edit Prerequisites for <span id="editSelectedCourseName"></span>
                </h5>
                <button type="button" class="btn-close"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPrerequisiteForm" action="/admin/confirmPreReqEdit" method="POST">
                    <input type="hidden" name="courseId" id="editSelectedCourseId">
                    <input type="hidden" name="successStatus" id="editSuccessStatus">
                    <input type="hidden" name="responseMessage" id="editResponseMessage">

                    <!-- Container for prerequisite groups -->
                    <div id="editPrerequisiteGroupsContainer" class="group-container">
                        <!-- Groups will be dynamically added here by JS -->
                    </div>

                    <!-- Button to add a new top-level prerequisite group -->
                    <button type="button" class="btn btn-outline-primary mt-3"
                            onclick="addNewPrerequisiteGroup()">
                        + Add Prerequisite Group
                    </button>

                    <!-- Expression Preview -->
                    <div id="editExpressionPreview"
                         class="mt-3 p-2 border border-secondary rounded"
                         style="font-family:monospace; background:#fafafa;">
                        (Expression Preview will appear here)
                    </div>

                    <hr>
                    <!-- Submit Button -->
                    <button type="submit"
                            class="btn btn-success w-100 mt-2"
                            onclick="submitEditPrerequisiteForm(event)">
                        Update Prerequisites
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ===== Select Course Modal ===== -->
<div class="modal fade" id="selectCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable" style="max-height: 80vh;">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Select a Course to Add</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Normal Search & Course List (default view) -->
                <div id="selectCourseListContainer">
                    <input type="text" class="form-control mb-2"
                           id="selectCourseSearch"
                           placeholder="Search courses..."
                           oninput="filterSelectCourseList()"/>

                    <!-- Programme (optional) -->
                    <div class="mb-2">
                        <label for="selectProgrammeDropdown" class="form-label">
                            Programme (optional)
                        </label>
                        <select id="selectProgrammeDropdown" class="form-select">
                            <option value="">(Any programmes)</option>
                            <!-- Populated via JS -->
                        </select>
                    </div>

                    <!-- The list of courses -->
                    <div id="selectCourseList" style="max-height: 50vh; overflow-y: auto;">
                        <!-- Dynamically populated in JS -->
                    </div>

                    <!-- "Add Special Condition" button -->
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-secondary"
                                onclick="showSpecialConditionForm()">
                            Add Special Condition
                        </button>
                    </div>
                </div>

                <!-- Special Condition Form (hidden by default) -->
                <div id="specialConditionForm" style="display: none;">
                    <div class="mb-2">
                        <label for="specialTypeSelect" class="form-label">Condition Type</label>
                        <select id="specialTypeSelect" class="form-select"
                                onchange="onSpecialTypeChange()">
                            <!-- Populated in JS by getSpecialTypes() -->
                        </select>
                    </div>

                    <!-- Fields for COMPLETION_LEVEL_PERCENT -->
                    <div id="completionLevelFields" style="display: none;">
                        <div class="mb-2">
                            <label for="targetLevelInput" class="form-label">Target Level</label>
                            <input type="number" id="targetLevelInput"
                                   class="form-control" placeholder="e.g. 300">
                        </div>
                        <div class="mb-2">
                            <label for="percentageValueInput" class="form-label">Percentage (e.g. 75%)</label>
                            <input type="number" id="percentageValueInput"
                                   class="form-control" min="1" max="100"
                                   placeholder="e.g. 75 for 75%">
                        </div>
                    </div>

                    <!-- Fields for ADMISSION_PROGRAMME -->
                    <div id="admissionProgrammeFields" style="display: none;">
                        <label class="form-label">
                            Select Programmes:
                        </label>
                        <div id="admissionProgrammeCheckboxes">
                            <!-- We'll dynamically create a checkbox for each programme here -->
                        </div>
                    </div>


                    <!-- Buttons to Add or go Back -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary"
                                onclick="addSpecialCondition()">
                            Add
                        </button>
                        <button type="button" class="btn btn-secondary ms-2"
                                onclick="hideSpecialConditionForm()">
                            Back to Course List
                        </button>
                    </div>
                </div> <!-- end #specialConditionForm -->
            </div> <!-- end .modal-body -->
        </div>
    </div>
</div>


<!-- Modal For Tree -->
<div class="modal fade" id="visualizeModal" tabindex="-1"
     aria-labelledby="visualizeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visualizeModalLabel">Prerequisite Diagram</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="mermaidContainer" style="overflow-x: auto;">
                    <!-- Will be replaced dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal (unchanged) -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1"
     aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to remove all prerequisites for
                <strong id="deleteCourseName"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger"
                        id="confirmDeleteBtn">Yes, Remove</button>
            </div>
        </div>
    </div>
</div>

<script src="/scripts/courses2.js"></script>
<script src="/scripts/courses.js"></script>
<script src="/scripts/courses1.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>
</body>
</html>
