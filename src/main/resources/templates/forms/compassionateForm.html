<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Application for Compassionate / Aegrotat Pass / Special Exam</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/styles/completion_form.css}">
  <style>
    .required {
      color: red;
      margin-left: 4px;
    }

    input:invalid, textarea:invalid, select:invalid {
      border: 2px solid red;
    }

    .scroll-highlight {
      animation: blink 1s ease-in-out 3;
    }

    @keyframes blink {
      0%, 100% { background-color: white; }
      50% { background-color: #ffe6e6; }
    }
  </style>
</head>
<body>
<div class="form-wrapper">
  <div class="invalid-feedback">Please enter a valid date</div>

  <!-- USP Banner Header -->
  <div style="background-color: white; padding: 30px 0 10px; text-align: center; border-bottom: 2px solid #ccc;">
    <img src="/images/usp_logo.png" alt="USP Logo" style="max-width: 280px; height: auto;">
  </div>

  <h1>Application for Compassionate / Aegrotat Pass / Special Exam</h1>

  <form th:action="@{/student/compassionate/submit}" method="post" enctype="multipart/form-data" th:object="${form}">

    <fieldset>
      <legend>What are you applying for?</legend>
      <label><input type="checkbox" name="applicationType" value="Compassionate Pass"> Compassionate Pass</label>
      <label><input type="checkbox" name="applicationType" value="Aegrotat Pass"> Aegrotat Pass</label>
      <label><input type="checkbox" name="applicationType" value="Special Examination"> Special Examination</label>
    </fieldset>

    <label for="reason">Reason for application: <span class="required">*</span></label>
    <textarea id="reason" name="reason" required th:text="*{reason}"></textarea>

    <label for="documents">Attach supporting documents:</label>
    <input type="file" id="documents" name="documents" multiple>

    <fieldset>
      <legend>SECTION A: Personal Details</legend>

      <label for="lastName">Last Name:</label>
      <input type="text" id="lastName" name="lastName" th:value="${student.lastName}" readonly>

      <label for="firstName">First Name:</label>
      <input type="text" id="firstName" name="firstName" th:value="${student.firstName}" readonly>

      <label for="dob">Date of Birth: <span class="required">*</span></label>
      <input type="date" id="dob" name="dob" th:value="*{dateOfBirth}" required>
      <span id="dobError" class="error-message"></span>

      <label for="studentId">Student ID Number:</label>
      <input type="text" id="studentId" name="studentId" th:value="${student.studentId}" readonly>

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" th:value="${student.email}" readonly>

      <label for="telephone">Telephone:</label>
      <input type="tel" id="telephone" name="telephone" th:value="${student.phoneNumber}" readonly>

      <label for="address">Address:</label>
      <textarea id="address" name="address" rows="3" th:text="${student.address}"></textarea>

      <label for="campus">Campus: <span class="required">*</span></label>
      <input type="text" id="campus" name="campus" th:value="*{campus}" required>

      <label for="semesterYear">Semester / Year: <span class="required">*</span></label>
      <input type="text" id="semesterYear" name="semesterYear" th:value="*{semesterYear}" required>
    </fieldset>

    <fieldset>
      <legend>SECTION B: Missed Exam Details</legend>
      <div id="examEntries">
        <div class="exam-group">
          <label>Course Code: <span class="required">*</span>
            <input type="text" name="courseCode" th:value="*{courseCode}" required>
          </label>
          <label>Exam Date: <span class="required">*</span>
            <input type="date" name="examDate" th:value="*{examDate}" required>
          </label>
          <label>Exam Time: <span class="required">*</span>
            <input type="time" name="examTime" th:value="*{examTime}" required>
          </label>
        </div>
      </div>
      <button type="button" onclick="addExam()">+ Add Another Exam</button>
    </fieldset>

    <fieldset>
      <legend>SECTION C: Application Details</legend>
      <p>Please explain the context of the issue clearly in the reason section above and attach official documents.</p>
      <p>Staff processing your form will verify this section using your evidence and will add recommendations separately.</p>
      <p>Please sign below to declare the legitimacy of the submission provided</p>

      <div>
        <label for="signature">Applicantâ€™s Signature: <span class="required">*</span></label>
        <input type="text" id="signature" name="studentSignature" required th:value="*{studentSignature}">

        <label for="submissionDate">Date: <span class="required">*</span></label>
        <input type="date" id="submissionDate" name="submissionDate" required th:value="*{submissionDate}">
        <span id="submissionDateError" class="error-message"></span>

      </div>
    </fieldset>

    <button type="submit">Submit Application</button>

  </form>
</div>


<script>
  function addExam() {
    const container = document.getElementById('examEntries');
    const newExam = container.firstElementChild.cloneNode(true);
    newExam.querySelectorAll("input").forEach(input => input.value = "");
    container.appendChild(newExam);
  }

  document.querySelector("form").addEventListener("submit", function (e) {
    let valid = true;
    const form = this;

    const dob = document.getElementById("dob");
    const dobError = document.getElementById("dobError");
    dobError.textContent = "";
    dob.classList.remove("scroll-highlight");

    const submissionDate = document.getElementById("submissionDate");
    const submissionDateError = document.getElementById("submissionDateError");
    submissionDateError.textContent = "";
    submissionDate.classList.remove("scroll-highlight");

    const today = new Date().toISOString().split("T")[0];

    if (dob.value && dob.value > today) {
      dobError.textContent = "Date of Birth cannot be in the future.";
      dob.classList.add("scroll-highlight");
      dob.scrollIntoView({ behavior: "smooth", block: "center" });
      valid = false;
    }

    if (submissionDate.value && submissionDate.value < today) {
      submissionDateError.textContent = "Signing date cannot be in the past.";
      submissionDate.classList.add("scroll-highlight");
      submissionDate.scrollIntoView({ behavior: "smooth", block: "center" });
      valid = false;
    }

    const firstInvalid = form.querySelector(":invalid");
    if (firstInvalid && valid === false) {
      e.preventDefault();
      return;
    }

    if (!valid) e.preventDefault();

    // mark all required labels
    document.querySelectorAll("label").forEach(label => {
      const fieldId = label.getAttribute("for");
      const input = document.getElementById(fieldId);
      if (input && input.required && !label.innerHTML.includes("*")) {
        label.innerHTML += ' <span class="required">*</span>';
      }
    });
  });
</script>

</body>
</html>
